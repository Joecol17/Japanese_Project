<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://save-score.japanesegyanburu.workers.dev; object-src 'none'; base-uri 'self'; form-action 'self' https://buy.stripe.com">
  <title>Blackjack</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/png" href="/images/japan.png">
  <link rel="shortcut icon" href="/images/japan.png">
  <link rel="icon" href="images/japan.png">
</head>
<body class="jp-theme">
  <header style="padding:12px;display:flex;gap:8px;align-items:center">
    <a class="leave-button" href="index.html">← Home</a>
    <a class="leave-button secondary" href="gambling.html">Leaderboard</a>
  </header>

  <main class="bj-casino">
    <header class="bj-hero">
      <div>
        <h1>Blackjack — 桜カジノ</h1>
        <p>Neon nights, soft felt, and clean deals. Choose your hands and play.</p>
      </div>
      <div class="bj-hero-badge">Table 07</div>
    </header>

    <section class="blackjack-area bj-table">
      <div class="bj-topbar">
        <div class="credits">Chips: <span id="bjCredits" class="dark-credits">500</span></div>
        <div class="bj-inputs">
          <label>Bet
            <input id="bjBet" type="number" min="1" step="1" value="10" />
          </label>
        </div>
        <div class="bj-presets">
          <button class="navbutton" data-preset="10">10</button>
          <button class="navbutton" data-preset="25">25</button>
          <button class="navbutton" data-preset="50">50</button>
          <button class="navbutton" data-preset="100">100</button>
          <button id="bjAllIn" class="navbutton">All In</button>
        </div>
        <div class="bj-actions">
          <button id="bjDeal" class="navbutton">Deal</button>
          <button id="bjAutoDeal" class="navbutton">Auto-Deal</button>
        </div>
      </div>

      <div id="bjStatus" class="bj-status">Place your bet and deal.</div>

        <div class="bj-table-layout">
          <div class="bj-dealer">
          <h3>Dealer — <span id="bjDealerVal">0</span></h3>
          <div class="bj-hand" id="dealerHand"></div>
        </div>

        <div class="bj-player">
          <h3>Player — <span id="bjPlayerVal">0</span></h3>
            <div class="bj-hand" id="playerHand"></div>
          <div class="controls">
            <button id="bjHit" class="navbutton">Hit</button>
            <button id="bjStand" class="navbutton">Stand</button>
          </div>
        </div>

        <aside class="bj-side">
          <div class="bj-save">
            <label>Your name
              <input id="bjName" placeholder="Player" maxlength="20" />
            </label>
            <button id="bjSave" class="navbutton">Save Score</button>
          </div>
          <section class="global-leaderboard">
            <h3>Global Leaderboard</h3>
            <ol id="bjLb">
              <li>Loading…</li>
            </ol>
          </section>
        </aside>
      </div>
    </section>

  </main>

  <div id="bjWinPopup" class="bj-win-popup" aria-live="polite" aria-hidden="true">
    <div class="bj-win-card">
      <div class="bj-win-title">You Win!</div>
      <div class="bj-win-message" id="bjWinMessage">Nice hand!</div>
      <button id="bjWinClose" class="navbutton">Continue</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_KMjAJb2ZmIiQ_0uRXkj_Z4GHaHhQM-w",
      authDomain: "japanese-slots.firebaseapp.com",
      projectId: "japanese-slots",
      storageBucket: "japanese-slots.firebasestorage.app",
      messagingSenderId: "524806796966",
      appId: "1:524806796966:web:ea10a2972e7f6cc25b6667"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lbEl = document.getElementById('bjLb');
    const saveBtn = document.getElementById('bjSave');
    const nameInput = document.getElementById('bjName');

    const q = query(collection(db, 'blackjack_scores'), orderBy('score','desc'), limit(5));
    onSnapshot(q, (snap) => {
      lbEl.innerHTML = '';
      snap.forEach(doc => {
        const d = doc.data();
        const li = document.createElement('li');
        li.textContent = `${d.name} — ${d.score}`;
        lbEl.appendChild(li);
      });
      if(lbEl.children.length === 0) lbEl.innerHTML = '<li>No scores yet.</li>';
    });

    const saveEndpoint = 'https://save-score.japanesegyanburu.workers.dev';

    saveBtn.addEventListener('click', async ()=>{
      const rawName = (nameInput.value || '').trim() || 'Player';
      const name = rawName.slice(0,20);
      const score = Number((window.getBlackjackCredits && window.getBlackjackCredits()) ?? 0);
      const maxBet = Number((window.getBlackjackMaxBet && window.getBlackjackMaxBet()) ?? 1);
      const roundsPlayed = Number((window.getBlackjackRoundsPlayed && window.getBlackjackRoundsPlayed()) ?? 1);
      const maxMultiplier = 2;
      // client-side validation to avoid accidental bad writes
      if(!Number.isFinite(score) || score < 0 || score > 50000){ alert('Invalid score value.'); return; }
      if(name.length === 0){ alert('Please enter a name.'); return; }
      try{ if(window.isNameBlocked && window.isNameBlocked(name)){ alert('Name contains inappropriate language — please choose another.'); return; } }catch(e){}
      await fetch(saveEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          score,
          collection: 'blackjack_scores',
          maxBet,
          maxMultiplier,
          roundsPlayed
        })
      });
      nameInput.value = '';
    });
  </script>

  <script src="js/blackjack.js"></script>

  <footer style="text-align:center;padding:20px;color:var(--dark-gray)">Global leaderboard is a frontend placeholder.</footer>
</body>
</html>


