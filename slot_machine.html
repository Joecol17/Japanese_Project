<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://save-score.japanesegyanburu.workers.dev; object-src 'none'; base-uri 'self'; form-action 'self' https://buy.stripe.com">
  <title>Mini Slot Game</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/png" href="/images/japan.png">
  <link rel="shortcut icon" href="/images/japan.png">
  <link rel="icon" href="images/japan.png">
</head>
<body class="jp-theme">
  <main class="container">
    <header>
      <div class="header-left">
        <h1>Lucky Reels <span class="jp">ラッキーリール</span></h1>
        <p class="subtitle">A small simulated gambling game — play for fun only.</p>
      </div>
      <div class="header-actions">
        <a class="nav-button" href="index.html" id="newPageBtn">Go to home page</a>
      </div>
    </header>
    

    <section class="game">
      <div class="panel">
        <div class="credits">Credits: <span id="credits">100</span></div>
        <div class="controls">
          <label>Bet:
            <select id="bet">
              <option value="1">1</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="5000">5000</option>
            </select>
          </label>
          <label class="custom-bet">Or custom:
            <input id="customBet" type="number" min="1" placeholder="Custom" />
          </label>
          <button id="allIn">All In</button>
          <button id="spin">Spin</button>
          
        </div>
      </div>

      <div class="machine">
        <div class="reels" id="reels">
          <div class="reel" id="r0"></div>
          <div class="reel" id="r1"></div>
          <div class="reel" id="r2"></div>
        </div>
        <div class="machine-base"></div>
      </div>

      <aside class="leaderboard" id="leaderboard">
        <div class="message" id="message">Good luck!</div>
        <h2>Leaderboard</h2>
        <div class="lb-controls">
          <input id="playerName" placeholder="Your name" maxlength="20" />
          <button id="saveScore">Save Score</button>
        </div>
        <ol id="lbList" class="lb-list"></ol>
        <div class="lb-actions">
          <!-- Export/Import removed to prevent manual JSON editing -->
        </div>
      </aside>

      
    </section>

    <div id="confetti-root" class="confetti-root" aria-hidden="true"></div>
    <div id="sakura-root" class="sakura-root" aria-hidden="true"></div>

    

    <footer>
      <small>For entertainment only. No real money involved.</small>
    </footer>
  </main>
  
    <a class="promo-anchor" href="/.netlify/functions/create-checkout-session" target="_blank" aria-label="Support — gives you 100% win rate">
      <span class="promo-text">Gives you 100% win rate</span>
      <img src="images/Screenshot 2026-01-27 132044.png" alt="support">
    </a>

  <script src="js/script.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    collection,
    query,
    orderBy,
    limit,
    onSnapshot,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyB_KMjAJb2ZmIiQ_0uRXkj_Z4GHaHhQM-w",
    authDomain: "japanese-slots.firebaseapp.com",
    projectId: "japanese-slots",
    storageBucket: "japanese-slots.appspot.com",
    messagingSenderId: "524806796966",
    appId: "1:524806796966:web:ea10a2972e7f6cc25b6667"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ELEMENTS
  const lbList = document.getElementById("lbList");
  const saveBtn = document.getElementById("saveScore");
  const nameInput = document.getElementById("playerName");

  // LIVE LEADERBOARD
  const q = query(
    collection(db, "scores"),
    orderBy("score", "desc"),
    limit(10)
  );

  onSnapshot(q, (snapshot) => {
    lbList.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.name} — ${data.score}`;
      lbList.appendChild(li);
    });
  });

  const saveEndpoint = 'https://save-score.japanesegyanburu.workers.dev';

  // Keep the UI in sync with the authoritative server wallet.
  // Any manual edits in the inspector will be overwritten by the server value.
  auth.onAuthStateChanged(async user => {
    if(!user) return;
    const uid = user.uid;
    const walletRef = doc(db, 'wallets', uid);

    // Optional: ensure wallet exists (server functions normally create/update it).
    try{
      const snap = await getDoc(walletRef);
      // If it doesn't exist we don't create it here because rules may block client writes.
    }catch(e){ /* ignore */ }

    // Overwrite displayed credits whenever server value changes
    onSnapshot(walletRef, snap => {
      if(!snap.exists()) return;
      const data = snap.data();
      if(typeof data.credits === 'number'){
        const el = document.getElementById('credits');
        if(el) el.textContent = String(data.credits);
      }
    }, err => console.warn('wallet onSnapshot error', err));
  });

  // SAVE SCORE (via callable cloud function)
  saveBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim() || 'Player';
    const score = Number(document.getElementById("credits").textContent) || 0;
    const betSelect = document.getElementById('bet');
    const customBet = document.getElementById('customBet');
    let maxBet = 1;
    try{
      if(betSelect && betSelect.options && betSelect.options.length){
        const lastOpt = betSelect.options[betSelect.options.length - 1];
        const optVal = Number(lastOpt && lastOpt.value);
        if(Number.isFinite(optVal) && optVal > maxBet) maxBet = optVal;
      }
      const customVal = Number(customBet && customBet.value);
      if(Number.isFinite(customVal) && customVal > maxBet) maxBet = customVal;
    }catch(e){}
    const roundsPlayed = Number((window.getSlotsRoundsPlayed && window.getSlotsRoundsPlayed()) ?? 1);
    const maxMultiplier = 10;

    if (!name) {
      alert("Enter your name");
      return;
    }

    try{
      if(window.isNameBlocked && window.isNameBlocked(name)){
        alert('Name contains inappropriate language — please choose another.');
        return;
      }
    }catch(e){ /* allow save on blocker error */ }

    try{
      // LOCAL PROFANITY CHECK (if available)
      try{
        if(window.isNameBlocked && window.isNameBlocked(name)){
          alert('Name contains inappropriate language — please choose another.');
          return;
        }
      }catch(e){ /* ignore blocker errors */ }

      // REMOTE PROFANITY CHECK + BACKUP
      try{
        const pvRes = await fetch('https://vector.profanity.dev', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: name })
        });
        if(pvRes && pvRes.ok){
          const pvJson = await pvRes.json().catch(()=>null);
          const flagged = pvJson && (pvJson.blocked || pvJson.flagged || pvJson.profanity || pvJson.bad || (typeof pvJson.score === 'number' && pvJson.score > 0.5));
          if(flagged){
            alert('Name contains inappropriate language — please choose another.');
            return;
          }
        }
      }catch(e){ /* network/profanity service error — proceed conservatively */ }

      const res = await fetch(saveEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          score,
          collection: 'scores',
          maxBet,
          maxMultiplier,
          roundsPlayed
        })
      });
      if(!res.ok){
        const text = await res.text();
        throw new Error(text || 'Save failed');
      }
      const data = await res.json();

      // Fire-and-forget backup log to profanity/backup endpoint with saved metadata
      (async function(){
        try{
          await fetch('https://vector.profanity.dev', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: name, saved: true, recordedScore: data && data.score ? data.score : score })
          });
        }catch(e){ /* ignore backup errors */ }
      })();

      alert('Score saved (server recorded score: ' + (data && data.score) + ')');
      nameInput.value = '';
    }catch(err){
      console.error('saveScore call failed', err);
      alert('Failed to save score: ' + (err && err.message ? err.message : String(err)));
    }
  });
  
  // Override client spin handler to use server-resolved spins.
  // Replace existing spin button to remove any previous listeners attached by `js/script.js`.
  (function(){
    const spinBtnOld = document.getElementById('spin');
    if(!spinBtnOld) return;
    const spinBtn = spinBtnOld.cloneNode(true);
    spinBtnOld.parentNode.replaceChild(spinBtn, spinBtnOld);

    // Map server indices to visuals using the icons exposed by the page script
    const ICONS = window.LUCKY_ICONS || [
      '<svg viewBox="0 0 64 64"><rect x="6" y="20" rx="8" width="52" height="24" fill="#fff7ec"/></svg>',
      '<svg viewBox="0 0 64 64"><path d="M12 30h36v8a8 8 0 0 1-8 8H20a8 8 0 0 1-8-8z"/></svg>',
      '<svg viewBox="0 0 64 64"><g transform="translate(32,20)"><circle cx="0" cy="0" r="8"/></g></svg>',
      '<svg viewBox="0 0 64 64"><rect x="6" y="6" width="52" height="52" rx="6"/></svg>',
      '<svg viewBox="0 0 64 64"><ellipse cx="32" cy="32" rx="16" ry="20"/></svg>',
      '<svg viewBox="0 0 64 64"><path d="M8 32c12 12 36 12 44 0-8-12-32-12-44 0z"/></svg>',
      '<svg viewBox="0 0 64 64"><rect x="6" y="6" width="52" height="52" rx="8"/></svg>'
    ];

    const reelsEls = [document.getElementById('r0'), document.getElementById('r1'), document.getElementById('r2')];
    const msgEl = document.getElementById('message');

    spinBtn.addEventListener('click', async ()=>{
      // read bet
      let bet = 0;
      try{ const cb = document.getElementById('customBet') && parseInt(document.getElementById('customBet').value,10); if(cb && cb>0) bet = cb; else bet = parseInt(document.getElementById('bet').value,10);}catch(e){ bet = parseInt(document.getElementById('bet').value,10);}      
      if(!Number.isFinite(bet) || bet<=0){ alert('Invalid bet'); return; }
      spinBtn.disabled = true; msgEl.textContent = 'Spinning (server)...';
      try{
        const placeSpin = httpsCallable(functions, 'placeBetAndSpin');
        const res = await placeSpin({ bet });
        const data = res.data || res;
        // animate quick spin then reveal server indices
        const finals = (data.indices && Array.isArray(data.indices)) ? data.indices : [0,1,2];
        // simple animation: cycle icons briefly then set finals staggered
        const intervals = [];
        for(let i=0;i<3;i++){
          intervals[i] = setInterval(()=>{ reelsEls[i].innerHTML = ICONS[Math.floor(Math.random()*ICONS.length)]; }, 60 + i*20);
        }
        const stops = [900,1200,1500];
        stops.forEach((t,i)=> setTimeout(()=>{
          clearInterval(intervals[i]);
          reelsEls[i].innerHTML = ICONS[ finals[i] % ICONS.length ];
          if(i===2){
            // finished
            const type = data.type || 'lose';
            const payout = data.payout || 0;
            const newCredits = (typeof data.newCredits !== 'undefined') ? data.newCredits : null;
            if(type === 'jackpot') msgEl.textContent = `JACKPOT! You won ${payout} credits!`;
            else if(type === 'pair') msgEl.textContent = `Nice! Pair pays ${payout} credits.`;
            else msgEl.textContent = 'No win — try again!';
            if(newCredits !== null) document.getElementById('credits').textContent = String(newCredits);
            spinBtn.disabled = false;
          }
        }, t), 0);

      }catch(err){
        console.error('Spin error', err);
        alert('Spin failed: ' + (err && err.message ? err.message : String(err)));
        spinBtn.disabled = false; msgEl.textContent = 'Spin failed.';
      }
    });
  })();
</script>




</body>
</html>
