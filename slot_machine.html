<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.googleapis.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://save-score.japanesegyanburu.workers.dev; object-src 'none'; base-uri 'self'; form-action 'self' https://buy.stripe.com">
  <title>Mini Slot Game</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" type="image/png" href="/images/japan.png">
  <link rel="shortcut icon" href="/images/japan.png">
  <link rel="icon" href="images/japan.png">
</head>
<body class="jp-theme">
  <main class="container">
    <header>
      <div class="header-left">
        <h1>Lucky Reels <span class="jp">ラッキーリール</span></h1>
        <p class="subtitle">A small simulated gambling game — play for fun only.</p>
      </div>
      <div class="header-actions">
        <a class="nav-button" href="index.html" id="newPageBtn">Go to home page</a>
      </div>
    </header>
    

    <section class="game">
      <div class="panel">
        <div class="credits">Credits: <span id="credits">100</span></div>
        <div class="controls">
          <label>Bet:
            <select id="bet">
              <option value="1">1</option>
              <option value="5">5</option>
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="500">500</option>
              <option value="1000">1000</option>
              <option value="5000">5000</option>
            </select>
          </label>
          <label class="custom-bet">Or custom:
            <input id="customBet" type="number" min="1" placeholder="Custom" />
          </label>
          <button id="allIn">All In</button>
          <button id="spin">Spin</button>
          
        </div>
      </div>

      <div class="machine">
        <div class="reels" id="reels">
          <div class="reel" id="r0"></div>
          <div class="reel" id="r1"></div>
          <div class="reel" id="r2"></div>
        </div>
        <div class="machine-base"></div>
      </div>

      <aside class="leaderboard" id="leaderboard">
        <div class="message" id="message">Good luck!</div>
        <h2>Leaderboard</h2>
        <div class="lb-controls">
          <input id="playerName" placeholder="Your name" maxlength="20" />
          <button id="saveScore">Save Score</button>
        </div>
        <ol id="lbList" class="lb-list"></ol>
        <div class="lb-actions">
          <!-- Export/Import removed to prevent manual JSON editing -->
        </div>
      </aside>

      
    </section>

    <div id="confetti-root" class="confetti-root" aria-hidden="true"></div>
    <div id="sakura-root" class="sakura-root" aria-hidden="true"></div>

    

    <footer>
      <small>For entertainment only. No real money involved.</small>
    </footer>
  </main>
  
    <a class="promo-anchor" href="https://buy.stripe.com/3cI00cfsH0wA1hp6Lw8IU00" target="_blank" aria-label="Support — gives you 100% win rate">
      <span class="promo-text">Gives you 100% win rate</span>
      <img src="images/Screenshot 2026-01-27 132044.png" alt="support">
    </a>

  <script src="js/script.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    query,
    orderBy,
    limit,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyB_KMjAJb2ZmIiQ_0uRXkj_Z4GHaHhQM-w",
    authDomain: "japanese-slots.firebaseapp.com",
    projectId: "japanese-slots",
    storageBucket: "japanese-slots.appspot.com",
    messagingSenderId: "524806796966",
    appId: "1:524806796966:web:ea10a2972e7f6cc25b6667"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ELEMENTS
  const lbList = document.getElementById("lbList");
  const saveBtn = document.getElementById("saveScore");
  const nameInput = document.getElementById("playerName");

  // LIVE LEADERBOARD
  const q = query(
    collection(db, "scores"),
    orderBy("score", "desc"),
    limit(10)
  );

  onSnapshot(q, (snapshot) => {
    lbList.innerHTML = "";
    snapshot.forEach((doc) => {
      const data = doc.data();
      const li = document.createElement("li");
      li.textContent = `${data.name} — ${data.score}`;
      lbList.appendChild(li);
    });
  });

  const saveEndpoint = 'https://save-score.japanesegyanburu.workers.dev';

  // SAVE SCORE (via callable cloud function)
  saveBtn.addEventListener("click", async () => {
    const name = nameInput.value.trim() || 'Player';
    const score = Number(document.getElementById("credits").textContent) || 0;
    const betSelect = document.getElementById('bet');
    const customBet = document.getElementById('customBet');
    let maxBet = 1;
    try{
      if(betSelect && betSelect.options && betSelect.options.length){
        const lastOpt = betSelect.options[betSelect.options.length - 1];
        const optVal = Number(lastOpt && lastOpt.value);
        if(Number.isFinite(optVal) && optVal > maxBet) maxBet = optVal;
      }
      const customVal = Number(customBet && customBet.value);
      if(Number.isFinite(customVal) && customVal > maxBet) maxBet = customVal;
    }catch(e){}
    const roundsPlayed = Number((window.getSlotsRoundsPlayed && window.getSlotsRoundsPlayed()) ?? 1);
    const maxMultiplier = 10;

    if (!name) {
      alert("Enter your name");
      return;
    }

    try{
      if(window.isNameBlocked && window.isNameBlocked(name)){
        alert('Name contains inappropriate language — please choose another.');
        return;
      }
    }catch(e){ /* allow save on blocker error */ }

    try{
      const res = await fetch(saveEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          score,
          collection: 'scores',
          maxBet,
          maxMultiplier,
          roundsPlayed
        })
      });
      if(!res.ok){
        const text = await res.text();
        throw new Error(text || 'Save failed');
      }
      const data = await res.json();
      alert('Score saved (server recorded score: ' + (data && data.score) + ')');
      nameInput.value = '';
    }catch(err){
      console.error('saveScore call failed', err);
      alert('Failed to save score: ' + (err && err.message ? err.message : String(err)));
    }
  });
</script>




</body>
</html>
